{% extends "base.html" %}

{% block title %}Dashboard - Indian Racing Benter Model{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="hero-section">
    <div class="container text-center">
        <h1 class="display-4 mb-3">
            <i class="fas fa-horse-head"></i> Indian Racing Benter Model
        </h1>
        <p class="lead mb-4">Advanced horse racing analysis using the proven Benter methodology</p>
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="card stats-card text-center">
                            <div class="card-body">
                                <i class="fas fa-calendar-alt fa-2x text-primary mb-2"></i>
                                <h4 class="card-title">{{ meetings|length }}</h4>
                                <p class="card-text">Race Meetings</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card stats-card text-center">
                            <div class="card-body">
                                <i class="fas fa-trophy fa-2x text-success mb-2"></i>
                                <h4 class="card-title">{{ meetings|selectattr('has_data')|list|length }}</h4>
                                <p class="card-text">Processed</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card stats-card text-center">
                            <div class="card-body">
                                <i class="fas fa-chart-line fa-2x text-warning mb-2"></i>
                                <h4 class="card-title">Benter</h4>
                                <p class="card-text">Methodology</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Main Content -->
<div class="container">
    <!-- Welcome Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle"></i> About the Benter Model
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <p class="lead">
                                The Benter method combines prior probabilities (based on horse characteristics) 
                                with market odds to create more accurate win probability estimates.
                            </p>
                            <p>
                                This implementation is specifically designed for Indian racing data formats and 
                                provides a complete pipeline from PDF parsing to model evaluation.
                            </p>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center">
                                <i class="fas fa-brain fa-3x text-primary mb-3"></i>
                                <h6>Smart Probability Combination</h6>
                                <p class="small text-muted">
                                    Geometric mean of prior and market probabilities
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Race Meetings -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-flag-checkered"></i> Race Meetings
                    </h5>
                    <button class="btn btn-sm btn-outline-primary" onclick="refreshMeetings()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
                <div class="card-body">
                    {% if meetings %}
                        <div class="row g-3">
                            {% for meeting in meetings %}
                            <div class="col-md-6 col-lg-4">
                                <div class="card race-card h-100">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <h6 class="card-title mb-0">{{ meeting.name }}</h6>
                                            {% if meeting.has_data %}
                                                <span class="badge bg-success">
                                                    <i class="fas fa-check"></i> Processed
                                                </span>
                                            {% else %}
                                                <span class="badge bg-warning">
                                                    <i class="fas fa-clock"></i> Raw Data
                                                </span>
                                            {% endif %}
                                        </div>
                                        
                                        <p class="card-text text-muted small">
                                            <i class="fas fa-calendar"></i> 
                                            {% if meeting.date|length >= 3 %}
                                                {{ meeting.date[2] }}/{{ meeting.date[1] }}/{{ meeting.date[0] }}
                                            {% else %}
                                                {{ meeting.date[0] }}
                                            {% endif %}
                                        </p>
                                        
                                        <div class="mt-3">
                                            {% if meeting.has_data %}
                                                <a href="/meeting/{{ meeting.id }}" class="btn btn-primary btn-sm w-100">
                                                    <i class="fas fa-chart-bar"></i> View Analysis
                                                </a>
                                            {% else %}
                                                <button class="btn btn-outline-secondary btn-sm w-100" disabled>
                                                    <i class="fas fa-cog"></i> Process Data
                                                </button>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-folder-open fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No Race Meetings Found</h5>
                            <p class="text-muted">
                                Add PDF files to the <code>data/raw/</code> directory to get started.
                            </p>
                            <div class="mt-3">
                                <button class="btn btn-primary" onclick="showSetupGuide()">
                                    <i class="fas fa-book"></i> Setup Guide
                                </button>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-bolt"></i> Quick Actions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <div class="d-grid">
                                <button class="btn btn-outline-primary" onclick="runPipeline()">
                                    <i class="fas fa-play"></i> Run Pipeline
                                </button>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="d-grid">
                                <button class="btn btn-outline-success" onclick="testSetup()">
                                    <i class="fas fa-vial"></i> Test Setup
                                </button>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="d-grid">
                                <button class="btn btn-outline-info" onclick="showDocumentation()">
                                    <i class="fas fa-book"></i> Documentation
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Model Information -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-cogs"></i> Model Components
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 text-center mb-3">
                            <i class="fas fa-file-pdf fa-2x text-danger mb-2"></i>
                            <h6>PDF Ingestion</h6>
                            <p class="small text-muted">Convert race cards, odds, and results</p>
                        </div>
                        <div class="col-md-3 text-center mb-3">
                            <i class="fas fa-database fa-2x text-primary mb-2"></i>
                            <h6>Feature Engineering</h6>
                            <p class="small text-muted">Combine horse data with market odds</p>
                        </div>
                        <div class="col-md-3 text-center mb-3">
                            <i class="fas fa-brain fa-2x text-success mb-2"></i>
                            <h6>Benter Model</h6>
                            <p class="small text-muted">Probability combination algorithm</p>
                        </div>
                        <div class="col-md-3 text-center mb-3">
                            <i class="fas fa-chart-line fa-2x text-warning mb-2"></i>
                            <h6>Backtesting</h6>
                            <p class="small text-muted">Performance evaluation and metrics</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center py-4">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h5 id="loadingMessage">Processing...</h5>
                <p class="text-muted">Please wait while we process your request.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function refreshMeetings() {
        showLoading('loadingModal');
        document.getElementById('loadingMessage').textContent = 'Refreshing meetings...';
        
        fetch('/api/meetings')
            .then(response => response.json())
            .then(data => {
                location.reload();
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Failed to refresh meetings', 'danger');
            })
            .finally(() => {
                hideLoading('loadingModal');
            });
    }
    
    function runPipeline() {
        showLoading('loadingModal');
        document.getElementById('loadingMessage').textContent = 'Running pipeline...';
        
        // Simulate pipeline run (in real implementation, this would call the backend)
        setTimeout(() => {
            hideLoading('loadingModal');
            showToast('Pipeline completed successfully!', 'success');
        }, 2000);
    }
    
    function testSetup() {
        showLoading('loadingModal');
        document.getElementById('loadingMessage').textContent = 'Testing setup...';
        
        // Simulate setup test (in real implementation, this would call the backend)
        setTimeout(() => {
            hideLoading('loadingModal');
            showToast('Setup test completed!', 'success');
        }, 1500);
    }
    
    function showSetupGuide() {
        showToast('Setup guide: Add PDF files to data/raw/ directory', 'info');
    }
    
    function showDocumentation() {
        showToast('Documentation: Check the README.md file', 'info');
    }
    
    // Auto-refresh meetings every 30 seconds
    setInterval(() => {
        // Only refresh if user is on the dashboard
        if (window.location.pathname === '/') {
            // Silent refresh - don't show loading
        }
    }, 30000);
</script>
{% endblock %}
